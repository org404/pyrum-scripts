set -e

host start --identify=true
host notify all
host listen
peer connect $TADDRESS

#
# TODO: try and add description if it affects anything explain
#
# gossip start
#
# topic_name="beacon_block"
# encoding="ssz_snappy"
# blocks_topic="/eth2/$FORK_DIGEST_NO_PREFIX/$topic_name/$encoding"
#
# gossip join --topic=$blocks_topic
# gossip list-peers $blocks_topic
# gossip log $blocks_topic

#
# This fixes disconnection issue for Lighthouse (tested for 5 minutes).
# Note: Although Lighthouse is still syncing during my test, so wrong fork digest
# issue might be present here.
# For Prysm it doesn't solve the problem though (??).
#
peer metadata serve $TID
peer metadata poll --interval 5s --force-update $TID

#
# This breaks connection to Prysm (??). On Lighthouse doesn't seem to affect anything.
#
# peer status serve $TID

#
# This breaks connection to Lighthouse and Prysm (??).
# Error:
#     beacon-chain[574514]: level=debug msg="Invalid status message from peer" error="wrong fork digest version" handler=status
# Fix: manually set proper fork digest version.
#
# peer status poll $TID

#
# This fixes disconnection issue by setting good value for $FORK_DIGEST
# (consequently $FORK_DIGEST_NO_PREFIX) with the help of logging in
# prysm synced node.
#
while true; do
    # TODO: find proper data / encode it
    other_data="0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007b00000000000000"
    rpc status req raw --raw --data "$FORK_DIGEST_NO_PREFIX$other_data" --peer-id $TID
    # Verify connection still opened
    peer list
    sleep 5s
done
